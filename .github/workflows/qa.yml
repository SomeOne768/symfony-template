name: QA Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, intl, pdo_mysql, xml
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction
        working-directory: service-app

      - name: Install NPM dependencies
        run: npm install
        working-directory: service-app

      - name: Run PHP-CS-Fixer
        run: php vendor/bin/php-cs-fixer fix --dry-run --diff
        working-directory: service-app

      - name: Run PHPStan
        run: php vendor/bin/phpstan analyse
        working-directory: service-app

      - name: Run Rector
        run: php vendor/bin/rector process src --dry-run
        working-directory: service-app

      - name: Run TwigCS
        run: php vendor/bin/twigcs templates
        working-directory: service-app

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: code-quality
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: symfony
          MYSQL_USER: symfony
          MYSQL_PASSWORD: symfony
          CI: true
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          extensions: mbstring, intl, pdo_mysql, xml
          coverage: none

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-interaction
        working-directory: service-app

      - name: Install NPM dependencies
        run: npm install
        working-directory: service-app

      - name: Build assets for tests
        run: yarn install && yarn dev
        working-directory: service-app

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
              echo "MySQL is up"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done
        working-directory: service-app

      - name: Prepare TEST database
        run: |
          mysql -h 127.0.0.1 -u root -proot -e "DROP DATABASE IF EXISTS symfony_test;"
          mysql -h 127.0.0.1 -u root -proot -e "CREATE DATABASE symfony_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
          php service-app/bin/console doctrine:migrations:migrate --env=test --no-interaction
          mysql -h 127.0.0.1 -u root -proot symfony_test < service-app/data/fixtures/db.dump.sql

      - name: Validate Doctrine schema
        run: php bin/console doctrine:schema:validate --env=test
        working-directory: service-app

      #      - name: Load fixtures
      #        run: php bin/console doctrine:fixtures:load --env=test --no-interaction
      #        working-directory: service-app

      - name: Run PHPUnit tests
        run: php bin/phpunit --colors=always
        working-directory: service-app

      - name: Run Behat tests
        run: php vendor/bin/behat --config=behat.yml
        working-directory: service-app
